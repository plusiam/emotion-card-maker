<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ 순간감정카드 메이커 v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-handwriting { font-family: 'Gaegu', cursive; }
        .font-dodum { font-family: 'Gowun Dodum', sans-serif; }
        .roulette-needle { transform-origin: bottom center; transition: transform 2s cubic-bezier(0.25, 1, 0.5, 1); }
        
        [contenteditable=true]:empty:before {
            content: attr(placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af;
        }
        
        .template-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .template-card.selected {
            ring: 3px;
            ring-color: #3b82f6;
            transform: scale(1.05);
        }
        
        .canvas-container {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .image-upload-area.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        /* 감정 애니메이션 */
        .emotion-pulse { animation: emotionPulse 0.6s ease-out; }
        @keyframes emotionPulse {
            0% { background-color: #fef3c7; transform: scale(1); }
            50% { background-color: #fde68a; transform: scale(1.02); }
            100% { background-color: #f9fafb; transform: scale(1); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 템플릿 배경들 - 감정 테마 */
        .template-joy { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }
        .template-love { background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); }
        .template-calm { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        .template-energy { background: linear-gradient(135deg, #ff7675 0%, #e17055 100%); }
        .template-nature { background: linear-gradient(135deg, #00b894 0%, #00a085 100%); }
        .template-creative { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); }
        .template-warm { background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%); }
        .template-sunset { background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 50%, #e17055 100%); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- 헤더 -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 font-handwriting">✨ 순간감정카드 메이커</h1>
                    <p class="text-lg text-gray-600 mt-2">지금 이 순간의 감정을 특별한 카드로 만들어보세요</p>
                </div>
                <div class="text-right text-sm text-gray-500">
                    <p>v2.0 - Enhanced Edition</p>
                    <p id="current-date" class="font-medium"></p>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- 왼쪽: 감정 입력 & 설정 -->
            <div class="xl:col-span-2 space-y-6">
                
                <!-- 감정 영감 뽑기 섹션 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">🎭 감정 영감 뽑기</h2>
                    <div class="text-center space-y-4">
                        <div class="relative w-48 h-48 mx-auto bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 rounded-full flex items-center justify-center shadow-inner" role="img" aria-label="감정 룰렛">
                            <div id="emotion-needle" class="roulette-needle absolute w-2 h-24 bg-red-500 rounded-t-full bottom-1/2 shadow-lg border-2 border-white"></div>
                            <div class="w-8 h-8 bg-white rounded-full z-10 border-4 border-red-500"></div>
                        </div>
                        <button id="btn-emotion-spin" class="bg-purple-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-purple-600 transition-colors text-xl shadow-md font-handwriting">🎯 감정 영감 받기</button>
                        <div class="bg-gray-50 p-4 rounded-xl min-h-[6rem] flex items-center justify-center text-center">
                            <p id="current-emotion" class="text-2xl text-gray-800 font-medium font-dodum">버튼을 눌러 시작하세요!</p>
                        </div>
                        <button id="btn-use-emotion" class="hidden bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors text-lg shadow font-handwriting">💫 이 감정 사용하기</button>
                    </div>
                </div>

                <!-- 기본 정보 입력 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">📝 감정카드 정보</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="input-name" class="block text-gray-700 font-medium mb-2">👤 이름:</label>
                            <input type="text" id="input-name" placeholder="이름을 입력해주세요" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" maxlength="15">
                        </div>
                        <div>
                            <label for="input-emotion" class="block text-gray-700 font-medium mb-2">💭 지금 이 순간의 감정:</label>
                            <input type="text" id="input-emotion" placeholder="예: 기쁨, 설렘, 아쉬움..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" maxlength="20">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="input-situation" class="block text-gray-700 font-medium mb-2">📖 상황 설명:</label>
                        <textarea id="input-situation" placeholder="지금 어디서, 무엇을 하며 이런 감정을 느끼고 있나요?" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 h-20 resize-none"></textarea>
                    </div>

                    <!-- 자동 테마 안내 -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-blue-800 text-sm">💡 감정을 입력하면 어울리는 배경 테마가 자동으로 선택됩니다!</p>
                    </div>
                </div>

                <!-- 테마 & 배경 설정 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">🎨 카드 디자인</h2>
                    
                    <!-- 테마 선택 -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">감정 테마 선택:</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="template-selection">
                            <div class="template-card template-joy w-full h-20 rounded-lg border-2 border-gray-200 selected" data-template="joy">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">😊 기쁨</div>
                            </div>
                            <div class="template-card template-love w-full h-20 rounded-lg border-2 border-gray-200" data-template="love">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">💕 사랑</div>
                            </div>
                            <div class="template-card template-calm w-full h-20 rounded-lg border-2 border-gray-200" data-template="calm">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">😌 평온</div>
                            </div>
                            <div class="template-card template-energy w-full h-20 rounded-lg border-2 border-gray-200" data-template="energy">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">⚡ 활기</div>
                            </div>
                            <div class="template-card template-nature w-full h-20 rounded-lg border-2 border-gray-200" data-template="nature">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">🌱 자연</div>
                            </div>
                            <div class="template-card template-creative w-full h-20 rounded-lg border-2 border-gray-200" data-template="creative">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">🎨 창의</div>
                            </div>
                            <div class="template-card template-warm w-full h-20 rounded-lg border-2 border-gray-200" data-template="warm">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">🔥 따뜻함</div>
                            </div>
                            <div class="template-card template-sunset w-full h-20 rounded-lg border-2 border-gray-200" data-template="sunset">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">🌅 노을</div>
                            </div>
                        </div>
                    </div>

                    <!-- 이미지 업로드 -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">📸 순간의 사진 (선택사항):</label>
                        <div class="flex gap-4 mb-4">
                            <button id="btn-upload" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium">📁 파일 선택</button>
                            <button id="btn-camera" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">📷 사진 촬영</button>
                        </div>
                        
                        <div id="image-upload-area" class="image-upload-area p-8 text-center">
                            <input type="file" id="image-input" class="hidden" accept="image/*">
                            <div id="upload-placeholder">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <p class="text-gray-600">이미지를 드래그하거나 클릭해서 업로드하세요</p>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded-lg">
                                <button id="remove-image" class="mt-2 text-red-500 hover:text-red-700 text-sm">✕ 이미지 제거</button>
                            </div>
                        </div>
                    </div>

                    <!-- 카메라 섹션 -->
                    <div id="camera-section" class="hidden mt-4">
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <video id="camera-video" class="w-full max-w-md mx-auto rounded-lg" autoplay muted playsinline></video>
                            <div class="flex justify-center gap-2 mt-4">
                                <button id="btn-switch-camera" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">🔄 전환</button>
                                <button id="btn-capture" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">📸 촬영</button>
                                <button id="btn-cancel-camera" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">❌ 취소</button>
                            </div>
                        </div>
                        <canvas id="capture-canvas" class="hidden"></canvas>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 실시간 미리보기 -->
            <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">🖼️ 실시간 미리보기</h2>
                
                <div class="canvas-container mb-4">
                    <canvas id="preview-canvas" width="400" height="600" class="w-full h-auto rounded-lg"></canvas>
                </div>

                <div class="space-y-3">
                    <button id="btn-download-png" class="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors text-lg shadow-md font-handwriting" disabled>📱 이미지로 저장</button>
                    <button id="btn-download-pdf" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors text-lg shadow-md font-handwriting" disabled>📄 PDF로 저장</button>
                    <button id="btn-reset" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-handwriting">🔄 새로 만들기</button>
                </div>

                <div class="mt-4 p-4 bg-purple-50 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-2">💡 제작 가이드</h3>
                    <ul class="text-sm text-purple-700 space-y-1">
                        <li>• 룰렛으로 감정 영감을 받아보세요</li>
                        <li>• 지금 이 순간의 감정을 써보세요</li>
                        <li>• 상황을 자세히 설명해보세요</li>
                        <li>• 테마를 선택하고 사진을 추가하세요</li>
                        <li>• 완성된 카드를 저장하고 공유하세요</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 감정 키워드 데이터
        const emotionInspiration = [
            "기쁨", "행복", "즐거움", "신남", "만족", "뿌듯함", 
            "사랑", "설렘", "따뜻함", "포근함", "애정", "그리움",
            "평온", "차분함", "여유", "안정", "편안함", "고요함",
            "활기", "열정", "에너지", "역동", "힘참", "생동감",
            "자유", "상쾌함", "청량감", "맑음", "싱그러움", "생기",
            "창의", "영감", "상상", "꿈", "환상", "신비로움",
            "아쉬움", "그리움", "쓸쓸함", "외로움", "슬픔", "우울",
            "분노", "짜증", "답답함", "스트레스", "화남", "불만",
            "두려움", "걱정", "불안", "긴장", "떨림", "무서움",
            "놀라움", "당황", "혼란", "의아함", "신기함", "경이로움"
        ];

        const emotionKeywords = {
            'joy': ['기쁨', '기쁘', '행복', '즐거', '신나', '재미', '웃음', '좋아', '만족', '즐겁', '쾌활', '유쾌', '상쾌'],
            'love': ['사랑', '설렘', '좋아해', '마음', '애정', '로맨', '연애', '달콤', '포근', '따스', '애틋'],
            'calm': ['평온', '차분', '고요', '조용', '편안', '안정', '평화', '여유', '느긋', '담담', '침착', '정적'],
            'energy': ['활기', '열정', '에너지', '신남', '흥미', '활발', '역동', '파워', '힘찬', '생동', '활력', '펄떡'],
            'nature': ['자연', '초록', '푸른', '맑은', '청량', '싱그', '생기', '건강', '자유', '상큼', '청명'],
            'creative': ['창의', '예술', '상상', '꿈', '환상', '독창', '발상', '아이디어', '영감', '신비', '마법'],
            'warm': ['따뜻', '포근', '아늑', '온화', '부드', '달콤', '감미', '친근', '정겨', '훈훈'],
            'sunset': ['노을', '석양', '황금', '오렌지', '붉은', '저녁', '낭만', '아름다', '감성', '몽환']
        };

        const templates = {
            joy: { background: 'linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%)', textColor: '#d35400' },
            love: { background: 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)', textColor: '#831843' },
            calm: { background: 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)', textColor: '#1e3a8a' },
            energy: { background: 'linear-gradient(135deg, #ff7675 0%, #e17055 100%)', textColor: '#c92a2a' },
            nature: { background: 'linear-gradient(135deg, #00b894 0%, #00a085 100%)', textColor: '#14532d' },
            creative: { background: 'linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)', textColor: '#581c87' },
            warm: { background: 'linear-gradient(135deg, #fab1a0 0%, #e17055 100%)', textColor: '#c92a2a' },
            sunset: { background: 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 50%, #e17055 100%)', textColor: '#c92a2a' }
        };

        // DOM 요소들
        const needle = document.getElementById('emotion-needle');
        const btnEmotionSpin = document.getElementById('btn-emotion-spin');
        const currentEmotion = document.getElementById('current-emotion');
        const btnUseEmotion = document.getElementById('btn-use-emotion');
        const inputName = document.getElementById('input-name');
        const inputEmotion = document.getElementById('input-emotion');
        const inputSituation = document.getElementById('input-situation');
        const templateSelection = document.getElementById('template-selection');
        const btnUpload = document.getElementById('btn-upload');
        const btnCamera = document.getElementById('btn-camera');
        const imageInput = document.getElementById('image-input');
        const imageUploadArea = document.getElementById('image-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeImageBtn = document.getElementById('remove-image');
        const cameraSection = document.getElementById('camera-section');
        const cameraVideo = document.getElementById('camera-video');
        const btnSwitchCamera = document.getElementById('btn-switch-camera');
        const btnCapture = document.getElementById('btn-capture');
        const btnCancelCamera = document.getElementById('btn-cancel-camera');
        const captureCanvas = document.getElementById('capture-canvas');
        const canvas = document.getElementById('preview-canvas');
        const ctx = canvas.getContext('2d');
        const btnDownloadPng = document.getElementById('btn-download-png');
        const btnDownloadPdf = document.getElementById('btn-download-pdf');
        const btnReset = document.getElementById('btn-reset');
        const currentDateElement = document.getElementById('current-date');

        // 상태 관리
        let isSpinning = false;
        let drawnEmotion = '';
        let selectedTemplate = 'joy';
        let backgroundImage = null;
        let cameraStream = null;
        let currentFacingMode = 'environment';
        let isManualThemeSelection = false;

        // 초기화
        function init() {
            const today = new Date();
            currentDateElement.textContent = today.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            updateTemplateSelection(selectedTemplate);
            renderCanvas();
        }

        // 감정 영감 뽑기
        function handleEmotionSpin() {
            if (isSpinning) return;
            isSpinning = true;
            drawnEmotion = '';
            
            needle.style.transform = `rotate(${Math.random() * 360 + 1080}deg)`;
            currentEmotion.textContent = "감정을 찾는 중...";
            btnUseEmotion.classList.add('hidden');
            btnEmotionSpin.disabled = true;

            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * emotionInspiration.length);
                drawnEmotion = emotionInspiration[randomIndex];
                currentEmotion.textContent = drawnEmotion;
                isSpinning = false;
                btnEmotionSpin.disabled = false;
                btnUseEmotion.classList.remove('hidden');
            }, 2000);
        }

        // 감정 사용하기
        function useEmotion() {
            if (drawnEmotion) {
                inputEmotion.value = drawnEmotion;
                
                // 자동 테마 적용
                if (!isManualThemeSelection) {
                    const detectedTheme = detectEmotionTheme(drawnEmotion);
                    if (detectedTheme) {
                        selectedTemplate = detectedTheme;
                        updateTemplateSelection(selectedTemplate);
                    }
                }
                
                renderCanvas();
                
                // 피드백
                btnUseEmotion.textContent = '✅ 적용됨!';
                btnUseEmotion.disabled = true;
                setTimeout(() => {
                    btnUseEmotion.textContent = '💫 이 감정 사용하기';
                    btnUseEmotion.disabled = false;
                }, 1000);
            }
        }

        // 감정 테마 자동 감지
        function detectEmotionTheme(emotionText) {
            if (!emotionText) return null;
            
            const text = emotionText.toLowerCase();
            for (const [theme, keywords] of Object.entries(emotionKeywords)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return theme;
                }
            }
            return null;
        }

        // 템플릿 선택 업데이트
        function updateTemplateSelection(template) {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                const isSelected = card.dataset.template === template;
                card.classList.toggle('selected', isSelected);
            });
        }

        // 파일명 생성
        function generateFileName(format) {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            const userName = inputName.value.trim() || '익명';
            const emotionName = inputEmotion.value.trim() || '감정';
            
            function sanitizeFileName(str) {
                return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, '_');
            }
            
            const cleanUserName = sanitizeFileName(userName);
            const cleanEmotionName = sanitizeFileName(emotionName);
            const baseName = `${dateString}_${cleanUserName}_${cleanEmotionName}_순간감정카드`;
            const extension = format === 'pdf' ? 'pdf' : 'png';
            
            return `${baseName}.${extension}`;
        }

        // 캔버스 렌더링
        function renderCanvas() {
            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 배경 그리기
                if (backgroundImage) {
                    const img = new Image();
                    img.onload = function() {
                        const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                        const scaledWidth = img.width * scale;
                        const scaledHeight = img.height * scale;
                        const x = (canvas.width - scaledWidth) / 2;
                        const y = (canvas.height - scaledHeight) / 2;
                        
                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        renderTextContent();
                    };
                    img.src = backgroundImage;
                } else {
                    // 그라데이션 배경
                    const template = templates[selectedTemplate];
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    
                    if (selectedTemplate === 'joy') {
                        gradient.addColorStop(0, '#ffeaa7');
                        gradient.addColorStop(1, '#fdcb6e');
                    } else if (selectedTemplate === 'love') {
                        gradient.addColorStop(0, '#fd79a8');
                        gradient.addColorStop(1, '#e84393');
                    } else if (selectedTemplate === 'calm') {
                        gradient.addColorStop(0, '#74b9ff');
                        gradient.addColorStop(1, '#0984e3');
                    } else if (selectedTemplate === 'energy') {
                        gradient.addColorStop(0, '#ff7675');
                        gradient.addColorStop(1, '#e17055');
                    } else if (selectedTemplate === 'nature') {
                        gradient.addColorStop(0, '#00b894');
                        gradient.addColorStop(1, '#00a085');
                    } else if (selectedTemplate === 'creative') {
                        gradient.addColorStop(0, '#a29bfe');
                        gradient.addColorStop(1, '#6c5ce7');
                    } else if (selectedTemplate === 'warm') {
                        gradient.addColorStop(0, '#fab1a0');
                        gradient.addColorStop(1, '#e17055');
                    } else if (selectedTemplate === 'sunset') {
                        gradient.addColorStop(0, '#fd79a8');
                        gradient.addColorStop(0.5, '#fdcb6e');
                        gradient.addColorStop(1, '#e17055');
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    renderTextContent();
                }
            } catch (error) {
                console.error('캔버스 렌더링 오류:', error);
            }
        }

        function renderTextContent() {
            try {
                const template = templates[selectedTemplate];
                ctx.fillStyle = template.textColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const nameText = inputName.value || "이름을 입력해주세요";
                const emotionText = inputEmotion.value || "지금 이 순간의 감정";
                const situationText = inputSituation.value || "지금 어디서, 무엇을 하며 이런 감정을 느끼고 있는지 적어보세요";
                const dateText = new Date().toLocaleDateString('ko-KR');
                
                // 제목 영역 (감정)
                ctx.font = 'bold 36px "Gowun Dodum", sans-serif';
                ctx.fillText(emotionText, canvas.width / 2, 80);
                
                // 이름
                ctx.font = '24px "Gowun Dodum", sans-serif';
                ctx.fillText(nameText, canvas.width / 2, 130);
                
                // 상황 설명 (중앙)
                ctx.font = '20px "Gowun Dodum", sans-serif';
                const maxWidth = canvas.width - 80;
                const lineHeight = 30;
                const startY = canvas.height / 2;
                
                wrapText(ctx, situationText, canvas.width / 2, startY, maxWidth, lineHeight);
                
                // 날짜 (하단)
                ctx.font = '18px "Gowun Dodum", sans-serif';
                ctx.fillText(dateText, canvas.width / 2, canvas.height - 50);
                
                // 다운로드 버튼 활성화
                const hasContent = inputName.value || inputEmotion.value || inputSituation.value;
                btnDownloadPng.disabled = !hasContent;
                btnDownloadPdf.disabled = !hasContent;
                
            } catch (error) {
                console.error('텍스트 렌더링 오류:', error);
            }
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }

            const totalHeight = lines.length * lineHeight;
            const startY = y - (totalHeight / 2) + (lineHeight / 2);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, x, startY + (index * lineHeight));
            });
        }

        // 이미지 업로드 처리
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    backgroundImage = e.target.result;
                    previewImg.src = backgroundImage;
                    uploadPlaceholder.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    renderCanvas();
                };
                reader.readAsDataURL(file);
            }
        }

        // 이미지 제거
        function removeImage() {
            backgroundImage = null;
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            imageInput.value = '';
            renderCanvas();
        }

        // 카메라 시작
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: currentFacingMode
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraSection.classList.remove('hidden');

            } catch (error) {
                console.error('카메라 접근 오류:', error);
                alert('카메라에 접근할 수 없습니다. 브라우저 설정을 확인해주세요.');
            }
        }

        // 카메라 전환
        async function switchCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        // 사진 촬영
        function capturePhoto() {
            const captureCtx = captureCanvas.getContext('2d');
            captureCanvas.width = cameraVideo.videoWidth;
            captureCanvas.height = cameraVideo.videoHeight;
            
            captureCtx.drawImage(cameraVideo, 0, 0, captureCanvas.width, captureCanvas.height);
            
            backgroundImage = captureCanvas.toDataURL('image/png');
            previewImg.src = backgroundImage;
            uploadPlaceholder.classList.add('hidden');
            imagePreview.classList.remove('hidden');
            
            stopCamera();
            renderCanvas();
            alert('📸 사진이 성공적으로 적용되었습니다!');
        }

        // 카메라 중지
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraSection.classList.add('hidden');
        }

        // 다운로드 함수들
        async function downloadCard(format) {
            try {
                const fileName = generateFileName(format);
                
                if (format === 'png') {
                    const link = document.createElement('a');
                    const exportCanvas = await html2canvas(canvas, {
                        scale: 2,
                        backgroundColor: null,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    link.download = fileName;
                    link.href = exportCanvas.toDataURL();
                    link.click();
                    alert(`📱 이미지가 "${fileName}"으로 저장되었습니다!`);
                    
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save(fileName);
                    alert(`📄 PDF가 "${fileName}"으로 저장되었습니다!`);
                }
                
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('다운로드 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 리셋 함수
        function resetAll() {
            if (confirm('모든 내용을 지우고 새로 작성하시겠습니까?')) {
                inputName.value = '';
                inputEmotion.value = '';
                inputSituation.value = '';
                currentEmotion.textContent = "버튼을 눌러 시작하세요!";
                btnUseEmotion.classList.add('hidden');
                drawnEmotion = '';
                backgroundImage = null;
                imagePreview.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                imageInput.value = '';
                isManualThemeSelection = false;
                selectedTemplate = 'joy';
                updateTemplateSelection(selectedTemplate);
                stopCamera();
                renderCanvas();
                alert('✨ 새로운 순간감정카드를 작성할 준비가 완료되었습니다!');
            }
        }

        // 이벤트 리스너들
        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            // 기본 이벤트들
            btnEmotionSpin.addEventListener('click', handleEmotionSpin);
            btnUseEmotion.addEventListener('click', useEmotion);
            
            // 입력 필드들
            inputName.addEventListener('input', renderCanvas);
            inputEmotion.addEventListener('input', function() {
                renderCanvas();
                
                // 자동 테마 적용 (수동 선택하지 않은 경우만)
                if (!isManualThemeSelection) {
                    const detectedTheme = detectEmotionTheme(this.value);
                    if (detectedTheme) {
                        selectedTemplate = detectedTheme;
                        updateTemplateSelection(selectedTemplate);
                        renderCanvas();
                    }
                }
            });
            inputSituation.addEventListener('input', renderCanvas);
            
            // 템플릿 선택
            templateSelection.addEventListener('click', (e) => {
                const templateCard = e.target.closest('.template-card');
                if (templateCard) {
                    selectedTemplate = templateCard.dataset.template;
                    isManualThemeSelection = true;
                    updateTemplateSelection(selectedTemplate);
                    renderCanvas();
                }
            });
            
            // 이미지 관련
            btnUpload.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageUpload);
            removeImageBtn.addEventListener('click', removeImage);
            
            // 드래그 앤 드롭
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });
            
            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('dragover');
            });
            
            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload({ target: { files } });
                }
            });
            
            // 카메라 관련
            btnCamera.addEventListener('click', startCamera);
            btnSwitchCamera.addEventListener('click', switchCamera);
            btnCapture.addEventListener('click', capturePhoto);
            btnCancelCamera.addEventListener('click', stopCamera);
            
            // 다운로드 & 리셋
            btnDownloadPng.addEventListener('click', () => downloadCard('png'));
            btnDownloadPdf.addEventListener('click', () => downloadCard('pdf'));
            btnReset.addEventListener('click', resetAll);
            
            // 페이지 종료 시 카메라 정리
            window.addEventListener('beforeunload', () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            });
        });
    </script>
</body>
</html>