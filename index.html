<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ ìˆœê°„ê°ì •ì¹´ë“œ ë©”ì´ì»¤ v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-handwriting { font-family: 'Gaegu', cursive; }
        .font-dodum { font-family: 'Gowun Dodum', sans-serif; }
        .roulette-needle { transform-origin: bottom center; transition: transform 2s cubic-bezier(0.25, 1, 0.5, 1); }
        
        [contenteditable=true]:empty:before {
            content: attr(placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af;
        }
        
        .template-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .template-card.selected {
            ring: 3px;
            ring-color: #3b82f6;
            transform: scale(1.05);
        }
        
        .canvas-container {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .image-upload-area.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        /* ê°ì • ì• ë‹ˆë©”ì´ì…˜ */
        .emotion-pulse { animation: emotionPulse 0.6s ease-out; }
        @keyframes emotionPulse {
            0% { background-color: #fef3c7; transform: scale(1); }
            50% { background-color: #fde68a; transform: scale(1.02); }
            100% { background-color: #f9fafb; transform: scale(1); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* í…œí”Œë¦¿ ë°°ê²½ë“¤ - ê°ì • í…Œë§ˆ */
        .template-joy { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }
        .template-love { background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); }
        .template-calm { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        .template-energy { background: linear-gradient(135deg, #ff7675 0%, #e17055 100%); }
        .template-nature { background: linear-gradient(135deg, #00b894 0%, #00a085 100%); }
        .template-creative { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); }
        .template-warm { background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%); }
        .template-sunset { background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 50%, #e17055 100%); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 font-handwriting">âœ¨ ìˆœê°„ê°ì •ì¹´ë“œ ë©”ì´ì»¤</h1>
                    <p class="text-lg text-gray-600 mt-2">ì§€ê¸ˆ ì´ ìˆœê°„ì˜ ê°ì •ì„ íŠ¹ë³„í•œ ì¹´ë“œë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
                </div>
                <div class="text-right text-sm text-gray-500">
                    <p>v2.0 - Enhanced Edition</p>
                    <p id="current-date" class="font-medium"></p>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- ì™¼ìª½: ê°ì • ì…ë ¥ & ì„¤ì • -->
            <div class="xl:col-span-2 space-y-6">
                
                <!-- ê°ì • ì˜ê° ë½‘ê¸° ì„¹ì…˜ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">ğŸ­ ê°ì • ì˜ê° ë½‘ê¸°</h2>
                    <div class="text-center space-y-4">
                        <div class="relative w-48 h-48 mx-auto bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 rounded-full flex items-center justify-center shadow-inner" role="img" aria-label="ê°ì • ë£°ë ›">
                            <div id="emotion-needle" class="roulette-needle absolute w-2 h-24 bg-red-500 rounded-t-full bottom-1/2 shadow-lg border-2 border-white"></div>
                            <div class="w-8 h-8 bg-white rounded-full z-10 border-4 border-red-500"></div>
                        </div>
                        <button id="btn-emotion-spin" class="bg-purple-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-purple-600 transition-colors text-xl shadow-md font-handwriting">ğŸ¯ ê°ì • ì˜ê° ë°›ê¸°</button>
                        <div class="bg-gray-50 p-4 rounded-xl min-h-[6rem] flex items-center justify-center text-center">
                            <p id="current-emotion" class="text-2xl text-gray-800 font-medium font-dodum">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!</p>
                        </div>
                        <button id="btn-use-emotion" class="hidden bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors text-lg shadow font-handwriting">ğŸ’« ì´ ê°ì • ì‚¬ìš©í•˜ê¸°</button>
                    </div>
                </div>

                <!-- ê¸°ë³¸ ì •ë³´ ì…ë ¥ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ“ ê°ì •ì¹´ë“œ ì •ë³´</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="input-name" class="block text-gray-700 font-medium mb-2">ğŸ‘¤ ì´ë¦„:</label>
                            <input type="text" id="input-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" maxlength="15">
                        </div>
                        <div>
                            <label for="input-emotion" class="block text-gray-700 font-medium mb-2">ğŸ’­ ì§€ê¸ˆ ì´ ìˆœê°„ì˜ ê°ì •:</label>
                            <input type="text" id="input-emotion" placeholder="ì˜ˆ: ê¸°ì¨, ì„¤ë ˜, ì•„ì‰¬ì›€..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" maxlength="20">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="input-situation" class="block text-gray-700 font-medium mb-2">ğŸ“– ìƒí™© ì„¤ëª…:</label>
                        <textarea id="input-situation" placeholder="ì§€ê¸ˆ ì–´ë””ì„œ, ë¬´ì—‡ì„ í•˜ë©° ì´ëŸ° ê°ì •ì„ ëŠë¼ê³  ìˆë‚˜ìš”?" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 h-20 resize-none"></textarea>
                    </div>

                    <!-- ìë™ í…Œë§ˆ ì•ˆë‚´ -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-blue-800 text-sm">ğŸ’¡ ê°ì •ì„ ì…ë ¥í•˜ë©´ ì–´ìš¸ë¦¬ëŠ” ë°°ê²½ í…Œë§ˆê°€ ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤!</p>
                    </div>
                </div>

                <!-- í…Œë§ˆ & ë°°ê²½ ì„¤ì • -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ¨ ì¹´ë“œ ë””ìì¸</h2>
                    
                    <!-- í…Œë§ˆ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">ê°ì • í…Œë§ˆ ì„ íƒ:</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="template-selection">
                            <div class="template-card template-joy w-full h-20 rounded-lg border-2 border-gray-200 selected" data-template="joy">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸ˜Š ê¸°ì¨</div>
                            </div>
                            <div class="template-card template-love w-full h-20 rounded-lg border-2 border-gray-200" data-template="love">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸ’• ì‚¬ë‘</div>
                            </div>
                            <div class="template-card template-calm w-full h-20 rounded-lg border-2 border-gray-200" data-template="calm">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸ˜Œ í‰ì˜¨</div>
                            </div>
                            <div class="template-card template-energy w-full h-20 rounded-lg border-2 border-gray-200" data-template="energy">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">âš¡ í™œê¸°</div>
                            </div>
                            <div class="template-card template-nature w-full h-20 rounded-lg border-2 border-gray-200" data-template="nature">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸŒ± ìì—°</div>
                            </div>
                            <div class="template-card template-creative w-full h-20 rounded-lg border-2 border-gray-200" data-template="creative">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸ¨ ì°½ì˜</div>
                            </div>
                            <div class="template-card template-warm w-full h-20 rounded-lg border-2 border-gray-200" data-template="warm">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸ”¥ ë”°ëœ»í•¨</div>
                            </div>
                            <div class="template-card template-sunset w-full h-20 rounded-lg border-2 border-gray-200" data-template="sunset">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ğŸŒ… ë…¸ì„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">ğŸ“¸ ìˆœê°„ì˜ ì‚¬ì§„ (ì„ íƒì‚¬í•­):</label>
                        <div class="flex gap-4 mb-4">
                            <button id="btn-upload" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium">ğŸ“ íŒŒì¼ ì„ íƒ</button>
                            <button id="btn-camera" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">ğŸ“· ì‚¬ì§„ ì´¬ì˜</button>
                        </div>
                        
                        <div id="image-upload-area" class="image-upload-area p-8 text-center">
                            <input type="file" id="image-input" class="hidden" accept="image/*">
                            <div id="upload-placeholder">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <p class="text-gray-600">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded-lg">
                                <button id="remove-image" class="mt-2 text-red-500 hover:text-red-700 text-sm">âœ• ì´ë¯¸ì§€ ì œê±°</button>
                            </div>
                        </div>
                    </div>

                    <!-- ì¹´ë©”ë¼ ì„¹ì…˜ -->
                    <div id="camera-section" class="hidden mt-4">
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <video id="camera-video" class="w-full max-w-md mx-auto rounded-lg" autoplay muted playsinline></video>
                            <div class="flex justify-center gap-2 mt-4">
                                <button id="btn-switch-camera" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ğŸ”„ ì „í™˜</button>
                                <button id="btn-capture" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">ğŸ“¸ ì´¬ì˜</button>
                                <button id="btn-cancel-camera" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">âŒ ì·¨ì†Œ</button>
                            </div>
                        </div>
                        <canvas id="capture-canvas" class="hidden"></canvas>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
            <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">ğŸ–¼ï¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h2>
                
                <div class="canvas-container mb-4">
                    <canvas id="preview-canvas" width="400" height="600" class="w-full h-auto rounded-lg"></canvas>
                </div>

                <div class="space-y-3">
                    <button id="btn-download-png" class="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors text-lg shadow-md font-handwriting" disabled>ğŸ“± ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                    <button id="btn-download-pdf" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors text-lg shadow-md font-handwriting" disabled>ğŸ“„ PDFë¡œ ì €ì¥</button>
                    <button id="btn-reset" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-handwriting">ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
                </div>

                <div class="mt-4 p-4 bg-purple-50 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-2">ğŸ’¡ ì œì‘ ê°€ì´ë“œ</h3>
                    <ul class="text-sm text-purple-700 space-y-1">
                        <li>â€¢ ë£°ë ›ìœ¼ë¡œ ê°ì • ì˜ê°ì„ ë°›ì•„ë³´ì„¸ìš”</li>
                        <li>â€¢ ì§€ê¸ˆ ì´ ìˆœê°„ì˜ ê°ì •ì„ ì¨ë³´ì„¸ìš”</li>
                        <li>â€¢ ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•´ë³´ì„¸ìš”</li>
                        <li>â€¢ í…Œë§ˆë¥¼ ì„ íƒí•˜ê³  ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”</li>
                        <li>â€¢ ì™„ì„±ëœ ì¹´ë“œë¥¼ ì €ì¥í•˜ê³  ê³µìœ í•˜ì„¸ìš”</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ê°ì • í‚¤ì›Œë“œ ë°ì´í„°
        const emotionInspiration = [
            "ê¸°ì¨", "í–‰ë³µ", "ì¦ê±°ì›€", "ì‹ ë‚¨", "ë§Œì¡±", "ë¿Œë“¯í•¨", 
            "ì‚¬ë‘", "ì„¤ë ˜", "ë”°ëœ»í•¨", "í¬ê·¼í•¨", "ì• ì •", "ê·¸ë¦¬ì›€",
            "í‰ì˜¨", "ì°¨ë¶„í•¨", "ì—¬ìœ ", "ì•ˆì •", "í¸ì•ˆí•¨", "ê³ ìš”í•¨",
            "í™œê¸°", "ì—´ì •", "ì—ë„ˆì§€", "ì—­ë™", "í˜ì°¸", "ìƒë™ê°",
            "ììœ ", "ìƒì¾Œí•¨", "ì²­ëŸ‰ê°", "ë§‘ìŒ", "ì‹±ê·¸ëŸ¬ì›€", "ìƒê¸°",
            "ì°½ì˜", "ì˜ê°", "ìƒìƒ", "ê¿ˆ", "í™˜ìƒ", "ì‹ ë¹„ë¡œì›€",
            "ì•„ì‰¬ì›€", "ê·¸ë¦¬ì›€", "ì“¸ì“¸í•¨", "ì™¸ë¡œì›€", "ìŠ¬í””", "ìš°ìš¸",
            "ë¶„ë…¸", "ì§œì¦", "ë‹µë‹µí•¨", "ìŠ¤íŠ¸ë ˆìŠ¤", "í™”ë‚¨", "ë¶ˆë§Œ",
            "ë‘ë ¤ì›€", "ê±±ì •", "ë¶ˆì•ˆ", "ê¸´ì¥", "ë–¨ë¦¼", "ë¬´ì„œì›€",
            "ë†€ë¼ì›€", "ë‹¹í™©", "í˜¼ë€", "ì˜ì•„í•¨", "ì‹ ê¸°í•¨", "ê²½ì´ë¡œì›€"
        ];

        const emotionKeywords = {
            'joy': ['ê¸°ì¨', 'ê¸°ì˜', 'í–‰ë³µ', 'ì¦ê±°', 'ì‹ ë‚˜', 'ì¬ë¯¸', 'ì›ƒìŒ', 'ì¢‹ì•„', 'ë§Œì¡±', 'ì¦ê²', 'ì¾Œí™œ', 'ìœ ì¾Œ', 'ìƒì¾Œ'],
            'love': ['ì‚¬ë‘', 'ì„¤ë ˜', 'ì¢‹ì•„í•´', 'ë§ˆìŒ', 'ì• ì •', 'ë¡œë§¨', 'ì—°ì• ', 'ë‹¬ì½¤', 'í¬ê·¼', 'ë”°ìŠ¤', 'ì• í‹‹'],
            'calm': ['í‰ì˜¨', 'ì°¨ë¶„', 'ê³ ìš”', 'ì¡°ìš©', 'í¸ì•ˆ', 'ì•ˆì •', 'í‰í™”', 'ì—¬ìœ ', 'ëŠê¸‹', 'ë‹´ë‹´', 'ì¹¨ì°©', 'ì •ì '],
            'energy': ['í™œê¸°', 'ì—´ì •', 'ì—ë„ˆì§€', 'ì‹ ë‚¨', 'í¥ë¯¸', 'í™œë°œ', 'ì—­ë™', 'íŒŒì›Œ', 'í˜ì°¬', 'ìƒë™', 'í™œë ¥', 'í„ë–¡'],
            'nature': ['ìì—°', 'ì´ˆë¡', 'í‘¸ë¥¸', 'ë§‘ì€', 'ì²­ëŸ‰', 'ì‹±ê·¸', 'ìƒê¸°', 'ê±´ê°•', 'ììœ ', 'ìƒí¼', 'ì²­ëª…'],
            'creative': ['ì°½ì˜', 'ì˜ˆìˆ ', 'ìƒìƒ', 'ê¿ˆ', 'í™˜ìƒ', 'ë…ì°½', 'ë°œìƒ', 'ì•„ì´ë””ì–´', 'ì˜ê°', 'ì‹ ë¹„', 'ë§ˆë²•'],
            'warm': ['ë”°ëœ»', 'í¬ê·¼', 'ì•„ëŠ‘', 'ì˜¨í™”', 'ë¶€ë“œ', 'ë‹¬ì½¤', 'ê°ë¯¸', 'ì¹œê·¼', 'ì •ê²¨', 'í›ˆí›ˆ'],
            'sunset': ['ë…¸ì„', 'ì„ì–‘', 'í™©ê¸ˆ', 'ì˜¤ë Œì§€', 'ë¶‰ì€', 'ì €ë…', 'ë‚­ë§Œ', 'ì•„ë¦„ë‹¤', 'ê°ì„±', 'ëª½í™˜']
        };

        const templates = {
            joy: { background: 'linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%)', textColor: '#d35400' },
            love: { background: 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)', textColor: '#831843' },
            calm: { background: 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)', textColor: '#1e3a8a' },
            energy: { background: 'linear-gradient(135deg, #ff7675 0%, #e17055 100%)', textColor: '#c92a2a' },
            nature: { background: 'linear-gradient(135deg, #00b894 0%, #00a085 100%)', textColor: '#14532d' },
            creative: { background: 'linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)', textColor: '#581c87' },
            warm: { background: 'linear-gradient(135deg, #fab1a0 0%, #e17055 100%)', textColor: '#c92a2a' },
            sunset: { background: 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 50%, #e17055 100%)', textColor: '#c92a2a' }
        };

        // DOM ìš”ì†Œë“¤
        const needle = document.getElementById('emotion-needle');
        const btnEmotionSpin = document.getElementById('btn-emotion-spin');
        const currentEmotion = document.getElementById('current-emotion');
        const btnUseEmotion = document.getElementById('btn-use-emotion');
        const inputName = document.getElementById('input-name');
        const inputEmotion = document.getElementById('input-emotion');
        const inputSituation = document.getElementById('input-situation');
        const templateSelection = document.getElementById('template-selection');
        const btnUpload = document.getElementById('btn-upload');
        const btnCamera = document.getElementById('btn-camera');
        const imageInput = document.getElementById('image-input');
        const imageUploadArea = document.getElementById('image-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeImageBtn = document.getElementById('remove-image');
        const cameraSection = document.getElementById('camera-section');
        const cameraVideo = document.getElementById('camera-video');
        const btnSwitchCamera = document.getElementById('btn-switch-camera');
        const btnCapture = document.getElementById('btn-capture');
        const btnCancelCamera = document.getElementById('btn-cancel-camera');
        const captureCanvas = document.getElementById('capture-canvas');
        const canvas = document.getElementById('preview-canvas');
        const ctx = canvas.getContext('2d');
        const btnDownloadPng = document.getElementById('btn-download-png');
        const btnDownloadPdf = document.getElementById('btn-download-pdf');
        const btnReset = document.getElementById('btn-reset');
        const currentDateElement = document.getElementById('current-date');

        // ìƒíƒœ ê´€ë¦¬
        let isSpinning = false;
        let drawnEmotion = '';
        let selectedTemplate = 'joy';
        let backgroundImage = null;
        let cameraStream = null;
        let currentFacingMode = 'environment';
        let isManualThemeSelection = false;

        // ì´ˆê¸°í™”
        function init() {
            const today = new Date();
            currentDateElement.textContent = today.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            updateTemplateSelection(selectedTemplate);
            renderCanvas();
        }

        // ê°ì • ì˜ê° ë½‘ê¸°
        function handleEmotionSpin() {
            if (isSpinning) return;
            isSpinning = true;
            drawnEmotion = '';
            
            needle.style.transform = `rotate(${Math.random() * 360 + 1080}deg)`;
            currentEmotion.textContent = "ê°ì •ì„ ì°¾ëŠ” ì¤‘...";
            btnUseEmotion.classList.add('hidden');
            btnEmotionSpin.disabled = true;

            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * emotionInspiration.length);
                drawnEmotion = emotionInspiration[randomIndex];
                currentEmotion.textContent = drawnEmotion;
                isSpinning = false;
                btnEmotionSpin.disabled = false;
                btnUseEmotion.classList.remove('hidden');
            }, 2000);
        }

        // ê°ì • ì‚¬ìš©í•˜ê¸°
        function useEmotion() {
            if (drawnEmotion) {
                inputEmotion.value = drawnEmotion;
                
                // ìë™ í…Œë§ˆ ì ìš©
                if (!isManualThemeSelection) {
                    const detectedTheme = detectEmotionTheme(drawnEmotion);
                    if (detectedTheme) {
                        selectedTemplate = detectedTheme;
                        updateTemplateSelection(selectedTemplate);
                    }
                }
                
                renderCanvas();
                
                // í”¼ë“œë°±
                btnUseEmotion.textContent = 'âœ… ì ìš©ë¨!';
                btnUseEmotion.disabled = true;
                setTimeout(() => {
                    btnUseEmotion.textContent = 'ğŸ’« ì´ ê°ì • ì‚¬ìš©í•˜ê¸°';
                    btnUseEmotion.disabled = false;
                }, 1000);
            }
        }

        // ê°ì • í…Œë§ˆ ìë™ ê°ì§€
        function detectEmotionTheme(emotionText) {
            if (!emotionText) return null;
            
            const text = emotionText.toLowerCase();
            for (const [theme, keywords] of Object.entries(emotionKeywords)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return theme;
                }
            }
            return null;
        }

        // í…œí”Œë¦¿ ì„ íƒ ì—…ë°ì´íŠ¸
        function updateTemplateSelection(template) {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                const isSelected = card.dataset.template === template;
                card.classList.toggle('selected', isSelected);
            });
        }

        // íŒŒì¼ëª… ìƒì„±
        function generateFileName(format) {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            const userName = inputName.value.trim() || 'ìµëª…';
            const emotionName = inputEmotion.value.trim() || 'ê°ì •';
            
            function sanitizeFileName(str) {
                return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, '_');
            }
            
            const cleanUserName = sanitizeFileName(userName);
            const cleanEmotionName = sanitizeFileName(emotionName);
            const baseName = `${dateString}_${cleanUserName}_${cleanEmotionName}_ìˆœê°„ê°ì •ì¹´ë“œ`;
            const extension = format === 'pdf' ? 'pdf' : 'png';
            
            return `${baseName}.${extension}`;
        }

        // ìº”ë²„ìŠ¤ ë Œë”ë§
        function renderCanvas() {
            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ë°°ê²½ ê·¸ë¦¬ê¸°
                if (backgroundImage) {
                    const img = new Image();
                    img.onload = function() {
                        const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                        const scaledWidth = img.width * scale;
                        const scaledHeight = img.height * scale;
                        const x = (canvas.width - scaledWidth) / 2;
                        const y = (canvas.height - scaledHeight) / 2;
                        
                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        renderTextContent();
                    };
                    img.src = backgroundImage;
                } else {
                    // ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
                    const template = templates[selectedTemplate];
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    
                    if (selectedTemplate === 'joy') {
                        gradient.addColorStop(0, '#ffeaa7');
                        gradient.addColorStop(1, '#fdcb6e');
                    } else if (selectedTemplate === 'love') {
                        gradient.addColorStop(0, '#fd79a8');
                        gradient.addColorStop(1, '#e84393');
                    } else if (selectedTemplate === 'calm') {
                        gradient.addColorStop(0, '#74b9ff');
                        gradient.addColorStop(1, '#0984e3');
                    } else if (selectedTemplate === 'energy') {
                        gradient.addColorStop(0, '#ff7675');
                        gradient.addColorStop(1, '#e17055');
                    } else if (selectedTemplate === 'nature') {
                        gradient.addColorStop(0, '#00b894');
                        gradient.addColorStop(1, '#00a085');
                    } else if (selectedTemplate === 'creative') {
                        gradient.addColorStop(0, '#a29bfe');
                        gradient.addColorStop(1, '#6c5ce7');
                    } else if (selectedTemplate === 'warm') {
                        gradient.addColorStop(0, '#fab1a0');
                        gradient.addColorStop(1, '#e17055');
                    } else if (selectedTemplate === 'sunset') {
                        gradient.addColorStop(0, '#fd79a8');
                        gradient.addColorStop(0.5, '#fdcb6e');
                        gradient.addColorStop(1, '#e17055');
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    renderTextContent();
                }
            } catch (error) {
                console.error('ìº”ë²„ìŠ¤ ë Œë”ë§ ì˜¤ë¥˜:', error);
            }
        }

        function renderTextContent() {
            try {
                const template = templates[selectedTemplate];
                ctx.fillStyle = template.textColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const nameText = inputName.value || "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”";
                const emotionText = inputEmotion.value || "ì§€ê¸ˆ ì´ ìˆœê°„ì˜ ê°ì •";
                const situationText = inputSituation.value || "ì§€ê¸ˆ ì–´ë””ì„œ, ë¬´ì—‡ì„ í•˜ë©° ì´ëŸ° ê°ì •ì„ ëŠë¼ê³  ìˆëŠ”ì§€ ì ì–´ë³´ì„¸ìš”";
                const dateText = new Date().toLocaleDateString('ko-KR');
                
                // ì œëª© ì˜ì—­ (ê°ì •)
                ctx.font = 'bold 36px "Gowun Dodum", sans-serif';
                ctx.fillText(emotionText, canvas.width / 2, 80);
                
                // ì´ë¦„
                ctx.font = '24px "Gowun Dodum", sans-serif';
                ctx.fillText(nameText, canvas.width / 2, 130);
                
                // ìƒí™© ì„¤ëª… (ì¤‘ì•™)
                ctx.font = '20px "Gowun Dodum", sans-serif';
                const maxWidth = canvas.width - 80;
                const lineHeight = 30;
                const startY = canvas.height / 2;
                
                wrapText(ctx, situationText, canvas.width / 2, startY, maxWidth, lineHeight);
                
                // ë‚ ì§œ (í•˜ë‹¨)
                ctx.font = '18px "Gowun Dodum", sans-serif';
                ctx.fillText(dateText, canvas.width / 2, canvas.height - 50);
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                const hasContent = inputName.value || inputEmotion.value || inputSituation.value;
                btnDownloadPng.disabled = !hasContent;
                btnDownloadPdf.disabled = !hasContent;
                
            } catch (error) {
                console.error('í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜¤ë¥˜:', error);
            }
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }

            const totalHeight = lines.length * lineHeight;
            const startY = y - (totalHeight / 2) + (lineHeight / 2);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, x, startY + (index * lineHeight));
            });
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    backgroundImage = e.target.result;
                    previewImg.src = backgroundImage;
                    uploadPlaceholder.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    renderCanvas();
                };
                reader.readAsDataURL(file);
            }
        }

        // ì´ë¯¸ì§€ ì œê±°
        function removeImage() {
            backgroundImage = null;
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            imageInput.value = '';
            renderCanvas();
        }

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: currentFacingMode
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraSection.classList.remove('hidden');

            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì¹´ë©”ë¼ ì „í™˜
        async function switchCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            const captureCtx = captureCanvas.getContext('2d');
            captureCanvas.width = cameraVideo.videoWidth;
            captureCanvas.height = cameraVideo.videoHeight;
            
            captureCtx.drawImage(cameraVideo, 0, 0, captureCanvas.width, captureCanvas.height);
            
            backgroundImage = captureCanvas.toDataURL('image/png');
            previewImg.src = backgroundImage;
            uploadPlaceholder.classList.add('hidden');
            imagePreview.classList.remove('hidden');
            
            stopCamera();
            renderCanvas();
            alert('ğŸ“¸ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì¹´ë©”ë¼ ì¤‘ì§€
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraSection.classList.add('hidden');
        }

        // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
        async function downloadCard(format) {
            try {
                const fileName = generateFileName(format);
                
                if (format === 'png') {
                    const link = document.createElement('a');
                    const exportCanvas = await html2canvas(canvas, {
                        scale: 2,
                        backgroundColor: null,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    link.download = fileName;
                    link.href = exportCanvas.toDataURL();
                    link.click();
                    alert(`ğŸ“± ì´ë¯¸ì§€ê°€ "${fileName}"ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save(fileName);
                    alert(`ğŸ“„ PDFê°€ "${fileName}"ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }
                
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë¦¬ì…‹ í•¨ìˆ˜
        function resetAll() {
            if (confirm('ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                inputName.value = '';
                inputEmotion.value = '';
                inputSituation.value = '';
                currentEmotion.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!";
                btnUseEmotion.classList.add('hidden');
                drawnEmotion = '';
                backgroundImage = null;
                imagePreview.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                imageInput.value = '';
                isManualThemeSelection = false;
                selectedTemplate = 'joy';
                updateTemplateSelection(selectedTemplate);
                stopCamera();
                renderCanvas();
                alert('âœ¨ ìƒˆë¡œìš´ ìˆœê°„ê°ì •ì¹´ë“œë¥¼ ì‘ì„±í•  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            // ê¸°ë³¸ ì´ë²¤íŠ¸ë“¤
            btnEmotionSpin.addEventListener('click', handleEmotionSpin);
            btnUseEmotion.addEventListener('click', useEmotion);
            
            // ì…ë ¥ í•„ë“œë“¤
            inputName.addEventListener('input', renderCanvas);
            inputEmotion.addEventListener('input', function() {
                renderCanvas();
                
                // ìë™ í…Œë§ˆ ì ìš© (ìˆ˜ë™ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°ë§Œ)
                if (!isManualThemeSelection) {
                    const detectedTheme = detectEmotionTheme(this.value);
                    if (detectedTheme) {
                        selectedTemplate = detectedTheme;
                        updateTemplateSelection(selectedTemplate);
                        renderCanvas();
                    }
                }
            });
            inputSituation.addEventListener('input', renderCanvas);
            
            // í…œí”Œë¦¿ ì„ íƒ
            templateSelection.addEventListener('click', (e) => {
                const templateCard = e.target.closest('.template-card');
                if (templateCard) {
                    selectedTemplate = templateCard.dataset.template;
                    isManualThemeSelection = true;
                    updateTemplateSelection(selectedTemplate);
                    renderCanvas();
                }
            });
            
            // ì´ë¯¸ì§€ ê´€ë ¨
            btnUpload.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageUpload);
            removeImageBtn.addEventListener('click', removeImage);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });
            
            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('dragover');
            });
            
            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload({ target: { files } });
                }
            });
            
            // ì¹´ë©”ë¼ ê´€ë ¨
            btnCamera.addEventListener('click', startCamera);
            btnSwitchCamera.addEventListener('click', switchCamera);
            btnCapture.addEventListener('click', capturePhoto);
            btnCancelCamera.addEventListener('click', stopCamera);
            
            // ë‹¤ìš´ë¡œë“œ & ë¦¬ì…‹
            btnDownloadPng.addEventListener('click', () => downloadCard('png'));
            btnDownloadPdf.addEventListener('click', () => downloadCard('pdf'));
            btnReset.addEventListener('click', resetAll);
            
            // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
            window.addEventListener('beforeunload', () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            });
        });
    </script>
</body>
</html>